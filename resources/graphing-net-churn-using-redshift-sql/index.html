<!DOCTYPE html>
<html lang="en-US" prefix="og: http://ogp.me/ns#">

<!-- Mirrored from www.getvero.com/resources/graphing-net-churn-using-redshift-sql/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 11 Dec 2018 15:24:54 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head >
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Graphing net churn using Redshift and SQL</title>

<!-- This site is optimized with the Yoast SEO plugin v8.2.1 - https://yoast.com/wordpress/plugins/seo/ -->
<meta name="description" content="Includes the full SQL script being used, so you can see the end goal. This SQL outputs a query table that has the month in the left column and then a column with a dollar figure for each upgrade, downgrades, gross churn and new revenue."/>
<link rel="canonical" href="index.html" />
<meta property="og:locale" content="en_US" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Graphing net churn using Redshift and SQL" />
<meta property="og:description" content="Includes the full SQL script being used, so you can see the end goal. This SQL outputs a query table that has the month in the left column and then a column with a dollar figure for each upgrade, downgrades, gross churn and new revenue." />
<meta property="og:url" content="index.html" />
<meta property="og:site_name" content="Vero" />
<meta property="article:section" content="How to" />
<meta property="article:published_time" content="2016-02-15T04:14:23+11:00" />
<meta property="article:modified_time" content="2018-05-19T02:17:27+11:00" />
<meta property="og:updated_time" content="2018-05-19T02:17:27+11:00" />
<meta property="og:image" content="https://i1.wp.com/www.getvero.com/wp-content/uploads/2016/02/SQL@2x.png?fit=1140%2C620&amp;ssl=1" />
<meta property="og:image:secure_url" content="https://i1.wp.com/www.getvero.com/wp-content/uploads/2016/02/SQL@2x.png?fit=1140%2C620&amp;ssl=1" />
<meta property="og:image:width" content="1140" />
<meta property="og:image:height" content="620" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:description" content="Includes the full SQL script being used, so you can see the end goal. This SQL outputs a query table that has the month in the left column and then a column with a dollar figure for each upgrade, downgrades, gross churn and new revenue." />
<meta name="twitter:title" content="Graphing net churn using Redshift and SQL" />
<meta name="twitter:image" content="https://i1.wp.com/www.getvero.com/wp-content/uploads/2016/02/SQL@2x.png?fit=1140%2C620&amp;ssl=1" />
<meta name="twitter:creator" content="@chexton" />
<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='http://s0.wp.com/' />
<link rel='dns-prefetch' href='http://secure.gravatar.com/' />
<link rel='dns-prefetch' href='http://fast.fonts.net/' />
<link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' />
<link rel='dns-prefetch' href='http://cdn.getvero.com/' />
<link rel='dns-prefetch' href='http://fonts.googleapis.com/' />
<link rel='dns-prefetch' href='http://cdn.rawgit.com/' />
<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="Vero &raquo; Feed" href="../../feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="Vero &raquo; Comments Feed" href="../../comments/feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="Vero &raquo; Graphing net churn using Redshift and SQL Comments Feed" href="feed/index.html" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/www.getvero.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.8"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='child-theme-css'  href='../../wp-content/themes/vero/style8036.css?ver=1527794841' type='text/css' media='all' />
<link rel='stylesheet' id='font-awesome-css'  href='../../wp-content/plugins/naked-social-share/assets/css/font-awesome.min1849.css?ver=4.7.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='../../wp-content/plugins/wordpress-popular-posts/public/css/wpp8aee.css?ver=4.1.2' type='text/css' media='all' />
<link rel='stylesheet' id='dashicons-css'  href='../../wp-includes/css/dashicons.min5010.css?ver=4.9.8' type='text/css' media='all' />
<link rel='stylesheet' id='highlight-css-css'  href='http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/tomorrow-night-bright.min.css?ver=2.6.1' type='text/css' media='all' />
<link rel='stylesheet' id='prism-css'  href='../../wp-content/themes/vero/assets/stylesheets/prismc141.css?ver=2.6.1' type='text/css' media='all' />
<link rel='stylesheet' id='prism-okaidia-css'  href='../../wp-content/themes/vero/assets/stylesheets/prism-okaidiac141.css?ver=2.6.1' type='text/css' media='all' />
<link rel='stylesheet' id='imgslider-style-css'  href='../../wp-content/themes/vero/assets/stylesheets/imgslider-2.0.1-minc141.css?ver=2.6.1' type='text/css' media='all' />
<link rel='stylesheet' id='custom-stylesheet-css'  href='https://cdn.getvero.com/app.min.css?ver=2.6.1' type='text/css' media='all' />
<link rel='stylesheet' id='googlefont_merriweather-css'  href='https://fonts.googleapis.com/css?family=Merriweather%3A700%2C700italic&amp;ver=4.9.8' type='text/css' media='all' />
<link rel='stylesheet' id='bxslider-style-css'  href='../../wp-content/themes/vero/assets/stylesheets/jquery.bxslider5010.css?ver=4.9.8' type='text/css' media='all' />
<link rel='stylesheet' id='featherlight-style-css'  href='http://cdn.rawgit.com/noelboss/featherlight/1.7.0/release/featherlight.min.css?ver=4.9.8' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack-widget-social-icons-styles-css'  href='../../wp-content/plugins/jetpack/modules/widgets/social-icons/social-iconsf4df.css?ver=20170506' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='../../wp-content/plugins/jetpack/css/jetpack8f99.css?ver=6.5' type='text/css' media='all' />
<script type='text/javascript' src='../../wp-includes/js/jquery/jqueryb8ff.js?ver=1.12.4'></script>
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery-migrate.min330a.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpp_params = {"sampling_active":"0","sampling_rate":"100","ajax_url":"https:\/\/www.getvero.com\/wp-json\/wordpress-popular-posts\/v1\/popular-posts\/","action":"update_views_ajax","ID":"7447","token":"87109256d6","debug":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/wordpress-popular-posts/public/js/wpp-4.1.0.min8aee.js?ver=4.1.2'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='https://www.getvero.com/wp-content/themes/genesis/lib/js/html5shiv.min.js?ver=3.7.3'></script>
<![endif]-->
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/fout.js'></script>
<script type='text/javascript' src='http://fast.fonts.net/jsapi/bd23cf03-685d-4ec1-b306-4adae883ab02.js'></script>
<link rel='https://api.w.org/' href='../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../wp-includes/wlwmanifest.xml" /> 
<link rel='shortlink' href='https://wp.me/p6YSXu-1W7' />
<link rel="alternate" type="application/json+oembed" href="../../wp-json/oembed/1.0/embed987b.json?url=https%3A%2F%2Fwww.getvero.com%2Fresources%2Fgraphing-net-churn-using-redshift-sql%2F" />
<link rel="alternate" type="text/xml+oembed" href="../../wp-json/oembed/1.0/embed38cc?url=https%3A%2F%2Fwww.getvero.com%2Fresources%2Fgraphing-net-churn-using-redshift-sql%2F&amp;format=xml" />

<link rel='dns-prefetch' href='http://v0.wordpress.com/'/>
<link rel='dns-prefetch' href='http://i0.wp.com/'/>
<link rel='dns-prefetch' href='http://i1.wp.com/'/>
<link rel='dns-prefetch' href='http://i2.wp.com/'/>
<style type='text/css'>img#wpstats{display:none}</style><link rel="icon" href="../../wp-content/themes/vero/assets/images/home/favicon/64.png" />
<link rel="pingback" href="../../xmlrpc.php" />
<!-- Google Tag Manager -->
<noscript><iframe src="http://www.googletagmanager.com/ns.html?id=GTM-M8KWK"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'http://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-M8KWK');</script>
<!-- End Google Tag Manager --></head>
<body class="post-template-default single single-post postid-7447 single-format-standard header-full-width full-width-content" itemscope itemtype="https://schema.org/WebPage"><div class="site-container"><nav class="nav-primary" aria-label="Main" itemscope itemtype="https://schema.org/SiteNavigationElement"><div class="wrap">  <ul id="menu-marketing-navbar-left" class="menu">
    <li id="logo" class="menu-item menu-item-type-custom menu-item-object-custom"><a href="../../index.html"><img data-no-retina src="../../wp-content/themes/vero/assets/images/home/logo/logo-blue.svg" width="104" height="36"></a></li>
    <li><a href="../../careers/index.html" class="hiring-pill">We're Hiring!</a></li>
  </ul>
  <ul id="menu-marketing-navbar-right" class="menu genesis-nav-menu menu-primary"><li id="menu-item-7514" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7514"><a title="Features" href="../../features/index.html" itemprop="url"><span itemprop="name">Features</span></a></li>
<li id="menu-item-2169" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2169"><a href="../../features/email/index.html" itemprop="url"><span itemprop="name">More</span></a>
<ul class="sub-menu">
	<li id="menu-item-7751" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7751"><a href="../../workflows/index.html" itemprop="url"><span itemprop="name">Workflows</span></a></li>
	<li id="menu-item-7601" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7601"><a href="../../event-manager/index.html" itemprop="url"><span itemprop="name">Event Management</span></a></li>
	<li id="menu-item-7502" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7502"><a href="../../fusion/index.html" itemprop="url"><span itemprop="name">Fusion</span></a></li>
	<li id="menu-item-7480" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7480"><a href="../../multi-language-campaigns/index.html" itemprop="url"><span itemprop="name">Multi-language Campaigns</span></a></li>
	<li id="menu-item-7600" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7600"><a href="../../reporting/index.html" itemprop="url"><span itemprop="name">Reporting</span></a></li>
</ul>
</li>
<li id="menu-item-2026" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2026"><a href="http://help.getvero.com/" itemprop="url"><span itemprop="name">Help</span></a></li>
<li id="menu-item-2120" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2120"><a href="../index.html" itemprop="url"><span itemprop="name">Blog</span></a></li>
<li id="menu-item-2025" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2025"><a href="../../pricing.html" itemprop="url"><span itemprop="name">Pricing</span></a></li>
<li id="menu-item-429" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-429"><a href="https://app.getvero.com/login" itemprop="url"><span itemprop="name">Log In</span></a></li>
<li id="menu-item-2119" class="btn btn-success menu-item menu-item-type-custom menu-item-object-custom menu-item-2119"><a title="button" href="https://app.getvero.com/signup" itemprop="url"><span itemprop="name">Start a free trial</span></a></li>
</ul>  <div class="nav-menu-toggle"><a href="#">Menu</a></div>
  </div></nav>
    <div id="blog-sub-menu" class="bottom-border-light">
      <div class="categories">
        <div class="category-button"><span class="fa fa-angle-down"></span></div>
        <ul id="categories-menu">
          <li class=""><a href="../index.html">All</a></li>
          <li class=""><a href="../category/vero-updates/index.html">Vero Updates</a></li>
          <li class=""><a href="../category/how-to/index.html">How To's</a></li>
          <li class=""><a href="../category/case-studies/index.html">Case Studies</a></li>
          <!-- <li class=""><a href="/resources/category/case-studies">Product Updates</a></li> -->
        </ul>
      </div>
      <form class="search-form" itemprop="potentialAction" itemscope itemtype="https://schema.org/SearchAction" method="get" action="https://www.getvero.com/" role="search"><meta itemprop="target" content="https://www.getvero.com/?s={s}"/><input itemprop="query-input" type="text" name="s" placeholder="Search the blog..." /><input type="submit" value="Search"  /></form>    </div>

  <div class="site-inner"><div class="content-sidebar-wrap">    <a href="../index.html" class="back-to-blog"><span class="fa fa-long-arrow-left"></span>Back to Blog</a>
  <main class="content"><article class="post-7447 post type-post status-publish format-standard has-post-thumbnail category-how-to entry" itemscope itemtype="https://schema.org/CreativeWork"><header class="entry-header"><h1 class="entry-title" itemprop="headline">Graphing net churn using Redshift and SQL</h1>
  <p class="entry-meta">
          <a href="../category/how-to/index.html">How to</a>
        Written On
    <time class="entry-time" itemprop="datePublished" datetime="2015-05-06T06:33:11+00:00">
      15 February, 2016    </time> 
    by 
    <span class="entry-author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person">
      Chris Hexton    </span> 
  </p>
        <img src="../../wp-content/uploads/2016/02/SQL%402x.png">
          <div class='shares-block'>
        <!-- <div class='total-shares'>
          <span>0</span>Shares
        </div> -->
        		<div class="naked-social-share nss-update-share-numbers" data-post-id="7447">
			<ul>
																				<li class="nss-twitter">
								<a href="http://www.twitter.com/intent/tweet?url=https%3A%2F%2Fwww.getvero.com%2Fresources%2Fgraphing-net-churn-using-redshift-sql%2F&amp;via=getvero&amp;text=Graphing+net+churn+using+Redshift+and+SQL" target="_blank">
									<i class="fa fa-twitter"></i>									<span class="nss-site-name">Twitter</span>
																	</a>
							</li>
																			<li class="nss-facebook">
								<a href="http://www.facebook.com/sharer/sharer.php?u=https://www.getvero.com/resources/graphing-net-churn-using-redshift-sql/&amp;t=Graphing+net+churn+using+Redshift+and+SQL" target="_blank">
									<i class="fa fa-facebook"></i>									<span class="nss-site-name">Facebook</span>
																	</a>
							</li>
																			<li class="nss-linkedin">
								<a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.getvero.com%2Fresources%2Fgraphing-net-churn-using-redshift-sql%2F&amp;title=Graphing+net+churn+using+Redshift+and+SQL&amp;source=Vero" target="_blank">
									<i class="fa fa-linkedin"></i>									<span class="nss-site-name">LinkedIn</span>
																	</a>
							</li>
														</ul>
		</div>
		      </div>
    </header><div class="entry-content" itemprop="text"><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><p>In 2015 two important trends emerged that everyone working to create great products and customer experiences will be interested in:</p>
<ol><li>It is easier than ever before to synchronise data from your SaaS tools <strong>into</strong> a data warehouse (often Amazon&rsquo;s <a href="http://docs.aws.amazon.com/redshift/latest/mgmt/welcome.html">Redshift</a>).</li>
<li>There are more and more great tools (<a href="http://periscopedata.com/">Periscope</a>, <a href="https://rjmetrics.com/product/pipeline/">RJ Metrics</a>, <a href="http://www.looker.com/">Looker</a>) that allow you to query and chart the  data in your  warehouse in a sophisticated way.</li>
</ol><p>We&rsquo;re big proponents for both of these trends at <a href="https://veropublic.wpengine.com/">Vero</a>. In this article, I&rsquo;m going to introduce you to capturing and analysing data directly from a database using Amazon&rsquo;s Redshift and Periscope Data. In this post we&rsquo;re going to chart some basic SaaS metrics.</p>
<p>I&rsquo;ve included a version of some <strong>actual</strong> SQL we use at Vero, and I&rsquo;ve broken down how it works so you can use it, get inspired by it or build upon it.</p>
<p>You can apply the same approach I use here to chart virtually <strong>anything</strong>.</p>
<p>Note that this is a <em>slightly</em> new direction for our blog. If you want to learn more about SQL then let me know in the comments. I&rsquo;m interested in breaking down how to chart other SaaS metrics, product usage, email interactions and so on. We&rsquo;re passionate about this here at Vero.</p>
<h2>Charting upgrades, downgrades, new revenue and churn</h2>
<p>Here&rsquo;s an example of the chart we&rsquo;ll be building, note that <em>news</em> means <em>new revenue</em> in this chart:</p>
<p class=" small-image" style="px"><img data-attachment-id="7448" data-permalink="https://www.getvero.com/resources/graphing-net-churn-using-redshift-sql/churn-and-revenue/" data-orig-file="https://i2.wp.com/www.getvero.com/wp-content/uploads/2016/02/churn-and-revenue.png?fit=954%2C316&amp;ssl=1" data-orig-size="954,316" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="churn-and-revenue" data-image-description="" data-medium-file="https://i2.wp.com/www.getvero.com/wp-content/uploads/2016/02/churn-and-revenue.png?fit=300%2C99&amp;ssl=1" data-large-file="https://i2.wp.com/www.getvero.com/wp-content/uploads/2016/02/churn-and-revenue.png?fit=954%2C316&amp;ssl=1" class="alignnone size-full wp-image-7448" src="https://i2.wp.com/veropublic.wpengine.com/wp-content/uploads/2016/02/churn-revenue-graph-sql.png" alt="churn-and-revenue.png" data-recalc-dims="1"></p>
<h2>What you&rsquo;ll need to do this yourself</h2>
<p>Here&rsquo;s the setup we use to get accurate and complete data and to chart it beautifully:</p>
<ul><li><a href="http://www.stripe.com/">Stripe</a> handles 90%  of Vero&rsquo;s payments, so that&rsquo;s the originator of the data in this graph.</li>
<li><a href="http://rjmetrics.com/product/pipeline/">RJ Metrics&rsquo; Pipeline</a> product syncs this payment data  from Stripe to our data warehouse.</li>
<li>Our data warehouse is hosted on a basic <a href="http://docs.aws.amazon.com/redshift/latest/mgmt/welcome.html">Amazon Web Services (AWS) Redshift</a> cluster.</li>
<li>We chart our reports using <a href="http://periscopedata.com/">Periscope Data</a>.</li>
<li>We also use our own database with data about our users (in this case, the companies that use Vero). Our application uses a PostgreSQL database for this.</li>
</ul><p>At our size, which is not insignificant, the primary cost here is Periscope. We use Periscope as it adds a caching layer and has some great features. We also graph a lot of other data in Periscope (not just the basic payment metrics) so this nets out well for us. The other products combined probably cost us around $300/month at this time (excluding Stripe fees, of course).</p>
<h2>The SQL</h2>
<p>To start off, I&rsquo;ve included the full SQL script being used, so you can see the end goal. This SQL outputs a query table that has the month in the left column and then a column with a dollar figure for each upgrade, downgrades, gross churn and new revenue.</p>
<p><a href="https://gist.github.com/chexton/aa6d842018cc08b1fcd1" target="_blank">See the full SQL</a>.</p>
<p>The resulting table can be charted using a tool like Periscope Data and a simple bar chart (as you saw in the example above).</p>
<p>Let&rsquo;s step through the key parts of this SQL. I&rsquo;m going to focus the patterns being used so that you can pick up a few tips on where to head with your own analyses.</p>
<h2>Listing all payments</h2>
<p>The first part of the query creates a temporary table called <code>all_payments</code> that holds every payment, the  customer ID it belongs to and two columns showing whether the payment was the first or last recorded for that  specific customer ID. This gives a nice clean set of data on which we can query throughout the rest of the SQL.</p>
<p>In this table, it&rsquo;s particularly important that we&rsquo;re extracting the first time a customer paid and the last time a customer paid as these represent the month they onboarded and the month they churned). These two columns provide an easy means of querying this later on.</p>
<pre><code class="hljs sql">with all_payments as (
  select 
    p.customer   as customer,
    p.date       as payment_date,
    p.total      as total,
    row_number() over(partition by p.customer 
      order by p.date desc) as first_row,
    row_number() over(partition by p.customer 
      order by p.date asc) as last_row
  from vero_stripe_production.stripe_invoices p
  where p.period_end - p.period_start &lt;= 2678400
)</code></pre>
<h2>Listing new customers, per month</h2>
<p>The following snippet of SQL creates a temporary table which holds the dollar value for new revenue in any given month. It has two columns: the <strong>month</strong> and the <strong>total new revenue</strong> for that month, in dollars.</p>
<pre><code class="hljs sql">news AS (
  select sum(all_payments.total)/100 as total,
    date_trunc('month', 
      (timestamp 'epoch' + all_payments.payment_date * interval '1 Second ')
    ) as month
  from all_payments
  where all_payments.last_row = 1
  group by date_trunc('month', 
    (timestamp 'epoch' + all_payments.payment_date * interval '1 Second ')
  )
)</code></pre>
<p>The SQL above queries the <code>all_payments</code> temporary table we created earlier and sums the <code>all_payments.total</code> column, grouped per month, to get the data we need.</p>
<p>There is one section of the query that is a bit fancy and worth reflecting on. Stripe stores the column <code>all_payments.payment_date</code> as a Unix integer timestamp. In order to output the nice, consistent date format <code>2016-02-01</code> we need to convert them. As we&rsquo;re using Redshift to do our queries, the following SQL example handles this:</p>
<pre><code class="hljs sql">date_trunc('month', 
      (timestamp 'epoch' + all_payments.payment_date * interval '1 Second ')
    )</code></pre>
<h2>Querying upgrades and downgrades between months</h2>
<p>The following SQL makes up the most complex in the entire query in the sense that there is a <strong>lot</strong> going on:</p>
<pre><code class="hljs sql">plan_changes as (
  select 
    vero_stripe_production.stripe_invoices.customer as customer,
    date_trunc('month', 
      (timestamp 'epoch' + vero_stripe_production.stripe_invoices.date * interval '1 Second ')
    ) as month,
    case vero_stripe_production.stripe_subscriptions.plan__interval 
      when 'year' 
      then vero_stripe_production.stripe_invoices.total/100/12 
      else vero_stripe_production.stripe_invoices.total/100 
      end as now,
    coalesce(
      case all_payments_by_month.plan__interval 
        when 'year' 
        then all_payments_by_month.total/100/12 
        else all_payments_by_month.total/100 
        end,
      0) as before,
    (case vero_stripe_production.stripe_subscriptions.plan__interval 
      when 'year' 
      then vero_stripe_production.stripe_invoices.total/100/12 
      else vero_stripe_production.stripe_invoices.total/100 
      end) - (coalesce(
        case all_payments_by_month.plan__interval 
        when 'year' 
        then all_payments_by_month.total/100/12 
        else all_payments_by_month.total/100 
        end,
      0)) as change
  from vero_stripe_production.stripe_invoices
  left outer join all_payments_by_month
    on date_trunc('month', add_months((timestamp 'epoch' + vero_stripe_production.stripe_invoices.date * interval '1 Second '),-1)) = all_payments_by_month.date_of_invoice
    and all_payments_by_month.customer = vero_stripe_production.stripe_invoices.customer
  join vero_stripe_production.stripe_subscriptions
    on vero_stripe_production.stripe_subscriptions.id = vero_stripe_production.stripe_invoices.subscription
  where vero_stripe_production.stripe_invoices.forgiven is not true
    and vero_stripe_production.stripe_invoices.paid is true
    and coalesce(all_payments_by_month.total/100,0)  0  
    and vero_stripe_production.stripe_invoices.period_end - vero_stripe_production.stripe_invoices.period_start </code></pre>
<p>Ultimately, this SQL query outputs a table with five columns: <code>customer</code> (the customer ID from Stripe), <code>month</code> (in the format <code>2016-02-01</code>), <code>now</code> (the amount the customer paid in the given month), <code>before</code> (the amount they paid the month before), <code>change</code> (the difference between <code>now</code> and <code>before</code>).</p>
<p>There are a few complex sections of this snippet, so I'll talk through these one-by-one.</p>
<p>Firstly, we use the SQL <code>case</code> statement. This allows us to return a one of two different results in the <code>now</code>, <code>before</code> and <code>change</code> columns based on the value of the <code>stripe_subscriptions.plan_interval</code> column.</p>
<p>In this example, we're checking whether the Stripe subscription <code>interval</code> is set to <code>year</code> or to <code>month</code>. If it's set to year, we divide the total payment made by 12. This is to ensure we smooth out the numbers -&Acirc;&nbsp;otherwise we'd see huge spikes in MRR in months where customers paid annually:</p>
<pre><code class="hljs sql">case vero_stripe_production.stripe_subscriptions.plan__interval 
      when 'year' 
      then vero_stripe_production.stripe_invoices.total/100/12 
      else vero_stripe_production.stripe_invoices.total/100 
      end as now</code></pre>
<p>We use this same methodology for the <code>before</code> and <code>change</code> columns.</p>
<p>In the <code>plan_changes</code> query we also do two joins. One of the joins is used to link the Stripe <code>vero_stripe_production.stripe_invoices</code> table we're using with the Stripe <code>vero_stripe_production.stripe_subscriptions</code>. To create this join we tell the query which column links the two tables. In this case it's the <code>stripe_subscriptions.id</code> column, as this <code>id</code> is present in both tables, represented as <code>stripe_subscriptions.id</code> and <code>stripe_invoices.subscription</code>:</p>
<pre><code class="hljs sql">join vero_stripe_production.stripe_subscriptions
    on vero_stripe_production.stripe_subscriptions.id = vero_stripe_production.stripe_invoices.subscription</code></pre>
<p>One final, handy little trick, in the <code>plan_changes</code> query is the use of <code>coalesce</code>. This tells the SQL to return either the first value or, if that's blank, return the second value. I have used this in a few places where we want to return <code>0</code> rather than <code>null</code> to ensure there is a value present that can be used in calculations. Here's an example:</p>
<pre><code>coalesce(all_payments_by_month.total/100, 0)</code></pre>
<h2>Pulling it all together</h2>
<p>The last part of the SQL creates the final table that will actually be charted. It has columns for <code>month</code>, <code>new</code> (new revenue), <code>churn</code>, <code>downgrades</code> and <code>upgrades</code>.</p>
<p>Before running this SQL we consolidate each key metrics into its own temporary table, one for <code>news</code>, one for <code>downgrades</code> and so on. We've already covered the temporary table <code>news</code> up above. That example outputs a table with each month and the dollar value of new revenue for that month. The same thing applies for the other three temporary tables we create in the overall SQL: <code>churns</code>, <code>downgrades</code> and <code>upgrades</code>.</p>
<p>We can then join and query <strong>all</strong> four tables and create one, clean table for Periscope Data to chart.</p>
<pre><code class="hljs sql">select 
  upgrades.month,
  upgrades.total                as upgrades,
  coalesce(downgrades.total,0)  as downgrades,
  coalesce(churns.total,0)*-1   as churn,
  coalesce(news.total,0)        as news
from upgrades
left outer join downgrades
  on upgrades.month = downgrades.month
left outer join churns
  on upgrades.month = churns.month
left outer join news
  on upgrades.month = news.month
where upgrades.month </code></pre>
<p>You'll note two things that are important about this query:</p>
<ul><li>We use a `left outer join` to ensure that if any of the tables we're querying are missing a value for a certain month that they do not cause the table to break.</li>
<li>We exclude the current month as this will always render incomplete and show wildly exaggerated churn and downgrade figures until the month passes (as not everyone has been charged for the current month as it proceeds).</li>
</ul><p>Both of these help ensure the resulting graph doesn't have any gaps or jagged data, keeping our graph accurate and smooth.</p>
<h2>Why use SQL at all?</h2>
<p>This example is just the tip of the iceberg! The beauty of using SQL for this sort of charting is that not only can you fully customise the resulting charts, but you can query data <strong>across</strong> databases, allowing you to do really sophisticated analyses. For example, we could run this same report but limit it to companies that have interacted with Vero in the last seven days, or to companies that have more than 50 campaigns, or to companies that have been with Vero for a certain amount of time.</p>
<p>If you're interested, please leave a comment or email me at chrish@getvero.com. There is so much that can be done with SQL and I'm excited to share how we use the same data to run queries across multiple databases and also chart our email interactions.</p>
<p>We've found running SQL queries allows us to produce consolidated reports which actually get looked at and actioned. It's forced us to be selective about what we query and this may be one of the most valuable aspects of the whole thing!</p>
<p><strong>Note: </strong>this script is slightly different from the one we use in production and has been pared down for this article, so if you see improvements or breaking code (though, it has been tested with our setup), please let me know and we'll update it.</p></body>
<!-- Mirrored from www.getvero.com/resources/graphing-net-churn-using-redshift-sql/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 11 Dec 2018 15:24:57 GMT -->
</html>
<!--<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
			xmlns:dc="http://purl.org/dc/elements/1.1/"
			xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
		<rdf:Description rdf:about="https://www.getvero.com/resources/graphing-net-churn-using-redshift-sql/"
    dc:identifier="https://www.getvero.com/resources/graphing-net-churn-using-redshift-sql/"
    dc:title="Graphing net churn using Redshift and SQL"
    trackback:ping="https://www.getvero.com/resources/graphing-net-churn-using-redshift-sql/trackback/" />
</rdf:RDF>-->
</div>    <div class='subscribe-form center-block'>
      <h2>Get our latest blog posts,<br>product news and tips straight to your inbox.</h2>
      <form action='https://app.getvero.com/forms/0eefc98b2dc881e7c0888ae698833577' method='post'>
          <input id="footer-email-address"  name='email' type='email' class="form-control" placeholder="email@address.com"></input>
          <input name='redirect_on_success' type='hidden' value='https://veropublic.wpengine.com/subscribed-to-the-blog/' />
          <input name='user[consent_marketing]' type='hidden' value='true' />
          <input name='user[consent_product_updates]' type='hidden' value='true' />
          <input type='submit' value='Subscribe' class="btn btn-success left-margin-tiny"/>
      </form>
      <p class="mini">By subscribing, you consent to let Vero send you messages regarding marketing and product. You can learn more in our <a href="../../privacy/index.html" target="_blank">Privacy Notice</a>, and you can opt out or change your consent at any time.</p>
    </div>
  <footer class="entry-footer"></footer></article>
<div id="disqus_thread"></div>
</main><aside class="widget-area"><section id="text-9" class="widget-odd widget-last widget-first widget-1 subscribe widget widget_text"><div class="widget-wrap"><h4 class="widget-title widgettitle">Subscribe for updates</h4>
			<div class="textwidget"><p>Get our latest blog posts, product news and tips straight to your inbox.</p>
<form class="mini-subscribe" action='https://app.getvero.com/forms/0eefc98b2dc881e7c0888ae698833577' method='post'>
  <input id="sidebar-email-address" class="email-add form-control" name='email' type='email' placeholder="Email Address" />
<input name='redirect_on_success' type='hidden' value='https://veropublic.wpengine.com/subscribed-to-the-blog/' />
<input name='user[consent_marketing]' type='hidden' value='true' />
<input name='user[consent_product_updates]' type='hidden' value='true' />
<input type="submit" class="btn btn-success" value="Subscribe">
</form>
<p class="mini">By subscribing, you consent to let Vero send you messages regarding marketing and product. You can learn more in our <a href="https://veropublic.wpengine.com/privacy" target="_blank">Privacy Notice</a>, and you can opt out or change your consent at any time.</p></div>
		</div></section>
</aside></div></div><footer class="site-footer" itemscope itemtype="https://schema.org/WPFooter"><div class="wrap">  <section id="call-to-action" class="center-text dark-box">
    <div class="inner">
      <h1 class="cta-title">Put your data first and craft better product experiences</h1>
      <p class="sub-heading">Create a free account, import your data and see how Vero can help your team.</p>
      <a class="btn btn-success btn-large btn-wide" href="http://app.getvero.com/signup">Get started</a>
    </div>
  </section>
    <div class="main-footer">
      <ul class="col">
    <li id="logo"><a href="../../index.html"><img src="../../wp-content/themes/vero/assets/images/home/logo/logo-white.svg" width="104"></a></li>
  </ul>
  <ul class="col">
    <li class="header">Product</li>
    <li><a href="../../features/index.html">Features</a></li>
    <li><a href="../../workflows/index.html">Workflows</a></li>
    <li><a href="../../event-manager/index.html">Event Management</a></li>
    <li><a href="../../fusion/index.html">Fusion</a></li>
    <li><a href="../../multi-language-campaigns/index.html">Multi-language</a></li>
    <li><a href="../../reporting/index.html">Reporting</a></li>
    <li><a href="../../integrations/vero-segment/index.html">Vero &plus; Segment</a></li>
    <li><a href="../../integrations/vero-stitch/index.html">Vero &plus; Stitch</a></li>
    <li><a href="../../integrations/vero-snowplow/index.html">Vero &plus; Snowplow</a></li>
    <li><a href="../../pricing.html">Pricing</a></li>
  </ul>
  <ul class="col">
    <li class="header">Resources</li>
    <!--<li>About</li>-->
    <li><a href="../index.html" target="_blank">Blog</a></li>
    <li ><a href="../../email-personalization-liquid-guide.html" target="_blank">Liquid Guide</a></li>
    <li><a href="https://help.getvero.com/" target="_blank">Help Center</a></li>
    <li><a href="https://developers.getvero.com/" target="_blank">API Reference</a></li>
    <li><a href="https://releasenotes.getvero.com/" target="_blank">Release Notes</a></li>
    <li><a href="https://status.getvero.com/" target="_blank">Status</a></li>
  </ul>
  <ul class="col">
    <li class="header">Company</li>
    <li><a href="../../careers/index.html">Careers</a><a href="../../careers/index.html" class="hiring-pill left-margin-tiny">We're Hiring!</a></li>
    <li><a href="../../terms-of-service/index.html">Terms of Service</a></li>
    <li><a href="../../privacy/index.html">Privacy Policy</a></li>
    <li><a href="../../gdpr/index.html">GDPR</a></li>
    <li><a href="https://twitter.com/getvero" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @getvero</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li>
  </ul>
    </div>
</div></footer></div><script data-cfasync="false">
  document.onreadystatechange = function () {
    if (document.readyState == "complete") {
      var logout_link = document.querySelectorAll('a[href*="wp-login.php?action=logout"]');
      if (logout_link) {
        for(var i=0; i < logout_link.length; i++) {
          logout_link[i].addEventListener( "click", function() {
            Intercom('shutdown');
          });
        }
      }
    }
  };
</script>
<script data-cfasync="false">
  window.intercomSettings = {"app_id":"i8y1wtxu"};
</script>
<script data-cfasync="false">(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',intercomSettings);}else{var d=document;var i=function(){i.c(arguments)};i.q=[];i.c=function(args){i.q.push(args)};w.Intercom=i;function l(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/i8y1wtxu';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);}if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})()</script>	<div style="display:none">
	</div>
<!--[if lte IE 8]>
<link rel='stylesheet' id='jetpack-carousel-ie8fix-css'  href='https://www.getvero.com/wp-content/plugins/jetpack/modules/carousel/jetpack-carousel-ie8fix.css?ver=20121024' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript' src='../../wp-content/plugins/jetpack/_inc/build/photon/photon.minb3d9.js?ver=20130122'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"theveroblog"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/disqus-comment-system/public/js/comment_count952b.js?ver=3.0.16'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"integration":"wordpress 3.0.16"},"disqusIdentifier":"7447 http:\/\/veropublic.wpengine.com\/?p=7447","disqusShortname":"theveroblog","disqusTitle":"Graphing net churn using Redshift and SQL","disqusUrl":"https:\/\/www.getvero.com\/resources\/graphing-net-churn-using-redshift-sql\/","postId":"7447"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/disqus-comment-system/public/js/comment_embed952b.js?ver=3.0.16'></script>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201850'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var NSS = {"ajaxurl":"https:\/\/www.getvero.com\/wp-admin\/admin-ajax.php","disable_js":"","nonce":"4c170e1f4d"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/naked-social-share/assets/js/naked-social-share.min1159.js?ver=1.4.2'></script>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=2018Decaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/modules/wpgroho5010.js?ver=4.9.8'></script>
<script type='text/javascript' src='../../wp-includes/js/comment-reply.min5010.js?ver=4.9.8'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/jquery.waypoints.min.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/scripts.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/dev_message.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/jquery.bxslider.min.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/featherlight.min.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/picturefill.min.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/jquery.parallax-scroll.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/prism.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/jquery.cookie.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/jquery.leanModal.min.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/smooth-scroll.min.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/homepage.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/features.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/pricing.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/blog.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/vendor/imgslider.min.js'></script>
<script type='text/javascript' src='../../wp-content/themes/vero/assets/scripts/landing-pages.js'></script>
<script type='text/javascript' src='http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js'></script>
<script type='text/javascript' src='../../wp-includes/js/wp-embed.min5010.js?ver=4.9.8'></script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/_inc/build/spin.min4e44.js?ver=1.3'></script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/_inc/build/jquery.spin.min4e44.js?ver=1.3'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/www.getvero.com\/wp-admin\/admin-ajax.php","nonce":"888d1c4d0f","display_exif":"1","display_geo":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","copyright":"Copyright","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/www.getvero.com\/wp-login.php?redirect_to=https%3A%2F%2Fwww.getvero.com%2Fresources%2Fgraphing-net-churn-using-redshift-sql%2F","blog_id":"1","meta_data":["camera","aperture","shutter_speed","focal_length","copyright"],"local_comments_commenting_as":"<fieldset><label for=\"email\">Email (Required)<\/label> <input type=\"text\" name=\"email\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-email-field\" \/><\/fieldset><fieldset><label for=\"author\">Name (Required)<\/label> <input type=\"text\" name=\"author\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-author-field\" \/><\/fieldset><fieldset><label for=\"url\">Website<\/label> <input type=\"text\" name=\"url\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-url-field\" \/><\/fieldset>"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/_inc/build/carousel/jetpack-carousel.mina4d5.js?ver=20170209'></script>
<script type='text/javascript' src='https://stats.wp.com/e-201850.js' async='async' defer='defer'></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:6.5',blog:'103168960',post:'7447',tz:'11',srv:'www.getvero.com'} ]);
	_stq.push([ 'clickTrackerInit', '103168960', '7447' ]);
</script>
</body></html>
